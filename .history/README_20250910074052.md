# HCP IDMS Operator

The HCP IDMS (Image Mirror Digest Set) Operator is designed to replicate the functionality of the Machine Config Operator's Image Mirror Digest Set feature for Hypershift environments.

## Overview

This operator watches for `ImageMirrorDigestSet` custom resources and generates registry configuration files in `/etc/containers/registry.conf.d/` on each node. It ignores resources named "default" and creates individual configuration files for each remaining resource.

## Features

- **DaemonSet Deployment**: Runs on every node in the cluster
- **Resource Filtering**: Automatically ignores "default" ImageMirrorDigestSet resources
- **Registry Configuration**: Generates TOML configuration files for container registries
- **Mirror Support**: Supports multiple mirrors per source registry
- **TLS Configuration**: Configurable TLS verification settings
- **File Safety**: Prevents overwriting configuration files owned by other processes

## Architecture

The operator consists of:

1. **Custom Resource Definition**: `ImageMirrorDigestSet` CRD
2. **Controller**: Watches and processes ImageMirrorDigestSet resources
3. **DaemonSet**: Deploys the operator on every node
4. **RBAC**: Proper permissions for cluster-wide resource access

## Custom Resource Definition

```yaml
apiVersion: config.openshift.io/v1alpha1
kind: ImageMirrorDigestSet
metadata:
  name: quay-mirror
spec:
  mirrors:
  - source: "quay.io"
    mirrors:
    - "mirror-registry.example.com/quay"
    - "backup-mirror.example.com/quay"
    insecureSkipTLSVerify: false
  - source: "registry.redhat.io"
    mirrors:
    - "mirror-registry.example.com/redhat"
    insecureSkipTLSVerify: false
```

## Generated Configuration

For each ImageMirrorDigestSet resource (except "default"), the operator generates a TOML configuration file in `/etc/containers/registry.conf.d/`:

```toml
# Generated by hcp-idms-operator
# Source: ImageMirrorDigestSet quay-mirror
# Generated at: 2024-01-15T10:30:00Z

[[registry]]
  location = "docker.io"
  prefix = ""

  [[registry.mirror]]
    location = "quay.io"
    [[registry.mirror.mirror]]
      location = "mirror-registry.example.com/quay"
    [[registry.mirror.mirror]]
      location = "backup-mirror.example.com/quay"

  [[registry.mirror]]
    location = "registry.redhat.io"
    [[registry.mirror.mirror]]
      location = "mirror-registry.example.com/redhat"
```

## Building and Deployment

### Prerequisites

- Go 1.25+
- Podman
- kubectl
- Access to a Kubernetes cluster

### Build

```bash
# Build the operator binary
make manager

# Build the Podman image
make podman-build

# Push the Podman image
make podman-push
```

### Deploy

```bash
# Deploy the CRD
make install

# Deploy the operator as DaemonSet
make deploy-daemonset

# Apply sample resources
kubectl apply -f config/samples/
```

### Development

```bash
# Run locally (requires cluster access)
make run

# Run tests
make test

# Generate manifests
make manifests
```

## Configuration

The operator is deployed as a DaemonSet with the following key configurations:

- **Host Path Mount**: `/etc/containers/registry.conf.d` is mounted from the host
- **RBAC**: Cluster-wide permissions to manage ImageMirrorDigestSet resources
- **Tolerations**: Runs on all nodes including master nodes
- **Security**: Non-root user with read-only root filesystem

## File Safety

The operator includes a safety mechanism to prevent accidental overwriting of configuration files managed by other processes:

- **Ownership Verification**: Before writing any configuration file, the operator checks if the file already exists
- **Header Validation**: If a file exists, the operator verifies that the first line contains `# Generated by hcp-idms-operator`
- **Safe Overwrite**: Only files with the correct header are overwritten; files with different headers are left untouched
- **Error Handling**: If a file exists with a different header, the operator logs an error and skips that file

This ensures that the operator only manages files it created and won't interfere with other tools or processes that might also write to the registry configuration directory.

## Monitoring

The operator exposes metrics on port 8080 and health checks on port 8081:

- Health check: `http://localhost:8081/healthz`
- Readiness check: `http://localhost:8081/readyz`
- Metrics: `http://localhost:8080/metrics`

## Troubleshooting

### Check Operator Status

```bash
# Check DaemonSet status
kubectl get daemonset -n system hcp-idms-operator

# Check pod logs
kubectl logs -n system -l app=hcp-idms-operator

# Check generated configuration files
kubectl exec -n system -l app=hcp-idms-operator -- ls -la /etc/containers/registry.conf.d/
```

### Verify Configuration

```bash
# Check ImageMirrorDigestSet resources
kubectl get imagemirrordigestsets

# Describe a specific resource
kubectl describe imagemirrordigestset quay-mirror
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests
5. Submit a pull request

## License

This project is licensed under the Apache License 2.0.
