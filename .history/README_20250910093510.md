# HCP IDMS Operator

The HCP IDMS (Image Mirror Digest Set) Operator is designed to replicate the functionality of the Machine Config Operator's Image Mirror Digest Set feature for Hypershift environments.

## Overview

This operator watches for `ImageMirrorDigestSet` custom resources and generates registry configuration files in `/etc/containers/registry.conf.d/` on each node. It ignores resources named "default" and creates individual configuration files for each remaining resource.

## Features

- **DaemonSet Deployment**: Runs on every node in the cluster
- **Resource Filtering**: Automatically ignores "default" and Hypershift-managed ImageMirrorDigestSet resources
- **Registry Configuration**: Generates TOML configuration files for container registries
- **Mirror Support**: Supports multiple mirrors per source registry
- **TLS Configuration**: Configurable TLS verification settings
- **File Safety**: Prevents overwriting configuration files owned by other processes
- **CRI-O Integration**: Automatically reloads CRI-O when configuration files change

## Architecture

The operator consists of:

1. **Custom Resource Definition**: `ImageMirrorDigestSet` CRD
2. **Controller**: Watches and processes ImageMirrorDigestSet resources
3. **DaemonSet**: Deploys the operator on every node
4. **RBAC**: Proper permissions for cluster-wide resource access

## Resource Filtering

The operator automatically ignores certain ImageMirrorDigestSet resources to prevent conflicts:

- **"default" resources**: Resources named "default" are ignored
- **Hypershift-managed resources**: Resources with the label `hypershift.openshift.io/managed: "true"` are ignored

This ensures the operator only manages resources that are explicitly intended for it and doesn't interfere with system-managed configurations.

## Custom Resource Definition

```yaml
apiVersion: config.openshift.io/v1alpha1
kind: ImageMirrorDigestSet
metadata:
  name: quay-mirror
spec:
  mirrors:
  - source: "quay.io"
    mirrors:
    - "mirror-registry.example.com/quay"
    - "backup-mirror.example.com/quay"
    insecureSkipTLSVerify: false
  - source: "registry.redhat.io"
    mirrors:
    - "mirror-registry.example.com/redhat"
    insecureSkipTLSVerify: false
```

## Generated Configuration

For each ImageMirrorDigestSet resource (except "default" and Hypershift-managed), the operator generates a TOML configuration file in `/etc/containers/registry.conf.d/`:

```toml
# Generated by hcp-idms-operator
# Source: ImageMirrorDigestSet quay-mirror
# Generated at: 2024-01-15T10:30:00Z

[[registry]]
  location = "docker.io"
  prefix = ""

  [[registry.mirror]]
    location = "quay.io"
    [[registry.mirror.mirror]]
      location = "mirror-registry.example.com/quay"
    [[registry.mirror.mirror]]
      location = "backup-mirror.example.com/quay"

  [[registry.mirror]]
    location = "registry.redhat.io"
    [[registry.mirror.mirror]]
      location = "mirror-registry.example.com/redhat"
```

## Building and Deployment

### Prerequisites

- Go 1.25+
- Podman
- oc
- Access to a Kubernetes cluster

### Build

```bash
# Build the operator binary
make manager

# Build the Podman image
make podman-build

# Push the Podman image
make podman-push
```

### Deploy

#### For Kubernetes
```bash
# Deploy the CRD
make install

# Deploy the operator as DaemonSet
make deploy-daemonset

# Apply sample resources
oc apply -f config/samples/
```

#### For OpenShift
```bash
# Deploy with SecurityContextConstraints (recommended for OpenShift)
make deploy-daemonset-openshift

# Apply sample resources
oc apply -f config/samples/
```

#### For OpenShift Development (BuildConfig)
```bash
# Deploy using BuildConfig for local development
make deploy-buildconfig

# Apply sample resources
oc apply -f config/samples/

# To rebuild and redeploy after code changes
make manager && oc start-build hcp-idms-operator --from-dir=. --follow
```

**Note**: The operator is deployed in the `openshift-hcp-idms-operator` namespace following OpenShift best practices.

### Development

#### Local Development
```bash
# Run locally (requires cluster access)
make run

# Run tests
make test

# Generate manifests
make manifests
```

#### OpenShift Development with BuildConfig

For development on OpenShift, you can use the BuildConfig approach which builds the operator from local source:

```bash
# Deploy using BuildConfig (builds from local source)
make deploy-buildconfig

# Rebuild and redeploy after code changes
make manager && oc start-build hcp-idms-operator --from-dir=. --follow

# Clean up BuildConfig deployment
./scripts/cleanup-buildconfig.sh
```

**BuildConfig Benefits:**
- **Local Development**: Builds from your local source code
- **Fast Iteration**: Easy to rebuild and redeploy after changes
- **OpenShift Integration**: Uses OpenShift's native build system
- **No External Registry**: Builds directly in the cluster

**BuildConfig Files:**
- `config/openshift/buildconfig.yaml`: BuildConfig definition
- `config/openshift/imagestream.yaml`: ImageStream for the built image
- `config/openshift/daemonset-buildconfig.yaml`: DaemonSet using the built image
- `Dockerfile.buildconfig`: Development-optimized Dockerfile

## Configuration

The operator is deployed as a DaemonSet with the following key configurations:

- **Namespace**: Deployed in `openshift-hcp-idms-operator` following OpenShift best practices
- **Host Path Mount**: `/etc/containers/registry.conf.d` is mounted from the host
- **RBAC**: Cluster-wide permissions to manage ImageMirrorDigestSet resources
- **Tolerations**: Runs on all nodes including master nodes
- **Security**: Non-root user with read-only root filesystem

### Namespace Choice

The operator uses the `openshift-hcp-idms-operator` namespace instead of the reserved `system` namespace. This follows OpenShift best practices by:

- **Avoiding System Namespace**: The `system` namespace is reserved for critical system components
- **Clear Naming**: The namespace name clearly identifies the operator's purpose
- **Isolation**: Provides proper isolation from other system components
- **Security**: Allows for proper RBAC and security policies

## CRI-O Integration

The operator automatically reloads CRI-O when it changes any registry configuration files. This ensures that:

- **Immediate Effect**: Registry changes take effect without manual intervention
- **No Restart Required**: CRI-O configuration is reloaded without restarting the service
- **Reliable Operation**: Uses both `systemctl reload crio` and `pkill -HUP crio` for maximum compatibility

### CRI-O Reload Mechanism

1. **Primary Method**: Uses `systemctl reload crio` for systemd-managed CRI-O
2. **Fallback Method**: Uses `pkill -HUP crio` if systemctl fails
3. **Error Handling**: Logs errors but doesn't fail the reconciliation if reload fails
4. **Permissions**: Requires SYS_ADMIN capability and /sys volume mount

## Security

### Security Context Constraints (OpenShift)

For OpenShift deployments, the operator includes a SecurityContextConstraints (SCC) that allows:

- **Host Path Access**: Required to write to `/etc/containers/registry.conf.d/`
- **Non-Root Execution**: Runs as user 65532 with appropriate group settings
- **Read-Only Root Filesystem**: Prevents container modifications
- **Minimal Capabilities**: Only SYS_ADMIN capability for CRI-O reload functionality
- **Init Container**: Sets up directory permissions before main container starts

### RBAC Permissions

The operator requires the following permissions:

- **ImageMirrorDigestSet Resources**: Full CRUD operations on `config.openshift.io/v1alpha1` resources
- **Status Updates**: Ability to update resource status and finalizers
- **Cluster-wide Access**: Required to watch resources across all namespaces

### Security Considerations

- **Host Path Writing**: The operator writes to host filesystem, requiring appropriate SCC permissions
- **Non-Root User**: Runs as user 65532 to minimize privilege escalation risks
- **File Ownership**: Init container ensures proper ownership of target directories
- **Read-Only Filesystem**: Main container runs with read-only root filesystem for security

## File Safety

The operator includes a safety mechanism to prevent accidental overwriting of configuration files managed by other processes:

- **Ownership Verification**: Before writing any configuration file, the operator checks if the file already exists
- **Header Validation**: If a file exists, the operator verifies that the first line contains `# Generated by hcp-idms-operator`
- **Safe Overwrite**: Only files with the correct header are overwritten; files with different headers are left untouched
- **Error Handling**: If a file exists with a different header, the operator logs an error and skips that file

This ensures that the operator only manages files it created and won't interfere with other tools or processes that might also write to the registry configuration directory.

## CRI-O Integration

After generating registry configuration files, the operator logs that CRI-O should be reloaded to pick up the changes. Administrators can reload CRI-O using:

```bash
# Reload CRI-O to pick up new registry configurations
systemctl reload crio

# Or restart CRI-O if reload is not available
systemctl restart crio
```

## Monitoring

The operator exposes metrics on port 8080 and health checks on port 8081:

- Health check: `http://localhost:8081/healthz`
- Readiness check: `http://localhost:8081/readyz`
- Metrics: `http://localhost:8080/metrics`

## Troubleshooting

### Check Operator Status

```bash
# Check DaemonSet status
oc get daemonset -n openshift-hcp-idms-operator hcp-idms-operator

# Check operator logs
oc logs -n openshift-hcp-idms-operator -l app=hcp-idms-operator

# Check generated configuration files
oc exec -n openshift-hcp-idms-operator -l app=hcp-idms-operator -- ls -la /etc/containers/registry.conf.d/
```

### Verify Configuration

```bash
# Check ImageMirrorDigestSet resources
oc get imagemirrordigestsets

# Describe a specific resource
oc describe imagemirrordigestset quay-mirror

# Check which resources are being ignored
oc get imagemirrordigestsets -o custom-columns=NAME:.metadata.name,MANAGED:.metadata.labels.hypershift\.openshift\.io/managed
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests
5. Submit a pull request

## License

This project is licensed under the Apache License 2.0.