# HCP IDMS Operator

> **⚠️ EXPERIMENTAL OPERATOR**
> This is an experimental operator and is **not officially supported by Red Hat**. Use it at your own risk. This operator is provided as-is for community use and experimentation.

A Kubernetes operator that manages `ImageDigestMirrorSet` resources for Hypershift environments, replicating the functionality of the Machine Config Operator's Image Mirror Digest Set feature.

## Overview

This operator watches for `ImageDigestMirrorSet` custom resources and generates registry configuration files in `/etc/containers/registries.conf.d/` on each node. It automatically ignores resources with the `hypershift.openshift.io/managed: "true"` label.

## Features

- **DaemonSet Deployment**: Runs on every node in the cluster
- **Resource Filtering**: Automatically ignores Hypershift-managed resources
- **CRI-O Integration**: Automatically reloads CRI-O when configuration changes
- **Security**: Runs as privileged container with proper RBAC and SCC
- **OpenShift Ready**: Includes SecurityContextConstraints for OpenShift deployments

## Prerequisites

- OpenShift cluster with `oc` CLI
- Go 1.24+ (for development)
- Podman (for building images)

## Quick Start

### Deploy to OpenShift

```bash
# Patch the mirror admission policy to only block on the hypershift label
oc get validatingadmissionpolicy mirror &> /dev/null && oc patch validatingadmissionpolicy mirror --type=json -p='[{"op": "add", "path": "/spec/matchConstraints/objectSelector", "value": {"matchExpressions":[{"key":"hypershift.openshift.io/managed","operator":"In","values":["true"]}]}}]'
```

```bash
# Clone the repository
git clone https://github.com/rh-mobb/hcp-idms-operator.git
cd hcp-idms-operator

# Deploy the operator
make deploy-daemonset-openshift

# Verify deployment
oc get pods -n openshift-hcp-idms-operator
```

### Create Sample Resources

```bash
# Apply sample ImageDigestMirrorSet
oc apply -f config/samples/config_v1_imagedigestmirrorset.yaml

# Check generated configuration
oc exec -n openshift-hcp-idms-operator -l app=hcp-idms-operator -- ls -la /etc/containers/registries.conf.d/
```

## Development

### Local Development

```bash
# Run locally in debug mode (logs configuration instead of writing files)
DEBUG_MODE=true go run cmd/manager/main.go

# Build the binary
make manager

# Run tests
make test
```

### Building Images

```bash
# Build for local architecture
make podman-build

# Build for x86 architecture
make podman-build-x86

# Push to registry
make podman-push
```

### Code Generation

```bash
# Generate manifests and deepcopy methods
make manifests

# Format and vet code
make fmt vet
```

## Configuration

The operator generates TOML configuration files for each `ImageDigestMirrorSet` resource:

```toml
# Generated by hcp-idms-operator
# Source: ImageDigestMirrorSet docker-mirror
# Generated at: 2024-01-15T10:30:00Z

[[registry]]
  location = "docker.io"
  prefix = ""

  [[registry.mirror]]
    location = "mirror-registry.example.com/docker"
    insecure = false
```

## Resource Structure

```yaml
apiVersion: config.openshift.io/v1
kind: ImageDigestMirrorSet
metadata:
  name: example-mirror
spec:
  imageDigestMirrors:
  - source: docker.io
    mirrors:
    - mirror-registry.example.com/docker
    insecureSkipTLSVerify: false
```

## Troubleshooting

### Common Issues

```bash
# Check operator logs
oc logs -n openshift-hcp-idms-operator -l app=hcp-idms-operator

# Check generated configuration files
oc exec -n openshift-hcp-idms-operator -l app=hcp-idms-operator -- cat /etc/containers/registries.conf.d/example-mirror.conf

# Check CRI-O status
oc exec -n openshift-hcp-idms-operator -l app=hcp-idms-operator -- systemctl status crio
```


## Security

- **Privileged Container**: Required to write to `/etc/containers/registries.conf.d/`
- **RBAC**: Cluster-wide permissions to manage ImageDigestMirrorSet resources
- **SCC**: SecurityContextConstraints for OpenShift deployments
- **Namespace**: Deployed in `openshift-hcp-idms-operator` namespace

## License

Licensed under the Apache License, Version 2.0. See [LICENSE](LICENSE) for details.